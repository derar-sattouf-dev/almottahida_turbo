{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
    <div class="row d-print-none">
        <div class="col-3">
            <div class="card">
                <div class="card-header">
                    Add Payment
                </div>
                <div class="card-body">
                    <form method="post" id="form" action="{% url 'seller.add_payment' seller.pk %}">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <label for="formFile" class="form-label">Payment image</label>
                        <input class="form-control" type="file" id="image">
                        <br>
                        <button type="submit" id="suB" class="btn btn-success">Add Payment</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-9">
            <div class="card">
                <div class="card-header">History</div>
                <div class="card-body">
                    <table id="results" class="table table-striped">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Total</th>
                            <th>Currency Rate</th>
                            <th>Discount</th>
                            <th>Date</th>
                        </tr>
                        </thead>
                        <tbody id="tbody">
                        {% for invoice in invoices %}
                            <tr>
                                <td><a href="{% url 'invoice.view' invoice.pk %}">#{{ invoice.pk }}</a></td>
                                <td>Invoice({{ invoice.type }})</td>
                                <td>{{ invoice.total }}{{ invoice.currency.name }}</td>
                                <td>---</td>
                                <td>{{ invoice.discount }}{{ invoice.currency.name }}</td>
                                <td>{{ invoice.date_added|date:"d-m-Y" }}</td>
                            </tr>
                        {% endfor %}
                        {% for payment in payments %}
                            <tr>
                                <td>#{{ payment.pk }}</td>
                                <td>Payment ({{ payment.operation }})</td>
                                <td>{{ payment.amount }}{{ payment.currency.name }}</td>
                                <td>{{ payment.rate }}</td>
                                <td>---</td>
                                <td>{{ payment.add_date|date:"d-m-Y" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th></th>
                    <th>Old Account</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <th></th>
                    <th id="oldaccount">{{ seller.old_account }}</th>
                    <th id="total">{{ total }}</th>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-12 d-none d-print-block">

        <table class="table table-striped">
            <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Total</th>
                <th>Currency Rate</th>
                <th>Discount</th>
                <th>Date</th>
            </tr>
            </thead>
            <tbody id="tbody">
            {% for invoice in invoices %}
                <tr>
                    <td><a href="{% url 'invoice.view' invoice.pk %}">#{{ invoice.pk }}</a></td>
                    <td>Invoice({{ invoice.type }})</td>
                    <td>{{ invoice.total }}{{ invoice.currency.name }}</td>
                    <td>---</td>
                    <td>{{ invoice.discount }}{{ invoice.currency.name }}</td>
                    <td>{{ invoice.date_added|date:"d-m-Y" }}</td>
                </tr>
            {% endfor %}
            {% for payment in payments %}
                <tr>
                    <td>---</td>
                    <td>Payment ({{ payment.operation }})</td>
                    <td>{{ payment.amount }}{{ payment.currency.name }}</td>
                    <td>{{ payment.rate }}</td>
                    <td>---</td>
                    <td>{{ payment.add_date|date:"d-m-Y" }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <table class="table">
        <thead>
        <tr>
            <th></th>
            <th>Old Account</th>
            <th>Total</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <th></th>
            <th>{{ seller.old_account }}</th>
            <th id="total">{{ total }}</th>
        </tr>
        </tbody>
    </table>

    <style>
        #div_id_image {
            display: none;
        }
    </style>
    <script>
        $('document').ready(function () {

            $.ajax({
                url: "https://sy.accounting.almottahida.org{% url 'seller.remote_payments' seller.name %}"
            }).done(function (data) {
                data = JSON.parse(data)
                console.log(data)
                var html = ""
                for (let i = 0; i < data.length; i++) {
                    let invoice = data[i]

                    let type = invoice.fields.operation
                    let total = parseFloat(invoice.fields.amount)
                    let nowTotal = parseFloat($("#total").text())
                    if (type === "Give") {
                        nowTotal += total
                    } else {
                        nowTotal -= total
                    }
                    $("#total").text(nowTotal)

                    let d = invoice.fields.add_date
                    let bigd = new Date(d)
                    html += "<tr>"
                    html += "<td>" + invoice.pk + "</td>"
                    html += "<td>" + "Payment(" + invoice.fields.operation + ")" + "</td>"
                    html += "<td>" + invoice.fields.amount + "$" + "</td>"


                    html += "<td>" + "----" + "</td>"
                    html += "<td>" + "----" + "</td>"
                    html += "<td>" + bigd.getDay() + "-" + bigd.getMonth() + "-" + bigd.getFullYear() + "</td>"
                    html += "</tr>"
                }
                $("#tbody").html($("#tbody").html() + html)
            })

            $.ajax({
                url: "https://sy.accounting.almottahida.org{% url 'seller.remote_invoices' seller.name %}"
            }).done(function (data) {
                data = JSON.parse(data)
                var html = ""
                html += "<tr><th>Sy</th></tr>"
                for (let i = 0; i < data.length; i++) {
                    let invoice = data[i]
                    let type = invoice.fields.type
                    let total = parseFloat(invoice.fields.total)
                    let nowTotal = parseFloat($("#total").text())
                    if (type === "Purchase") {
                        nowTotal -= total
                    } else {
                        nowTotal += total
                    }
                    $("#total").text(nowTotal)
                    let d = invoice.fields.date_added
                    let bigd = new Date(d)
                    html += "<tr>"
                    html += "<td>" + invoice.pk + "</td>"
                    html += "<td>" + "Invoice(" + invoice.fields.type + ")" + "</td>"

                    html += "<td>" + invoice.fields.total + "</td>"
                    html += "<td>" + "----" + "</td>"
                    html += "<td>" + invoice.fields.discount + "</td>"
                    html += "<td>" + bigd.getDay() + "-" + bigd.getMonth() + "-" + bigd.getFullYear() + "</td>"
                    html += "</tr>"
                }
                $("#tbody").html($("#tbody").html() + html)
            })

            $("#suB").click(function (e) {
                e.preventDefault()
                const response = prompt("Are You Sure ?")
                if (response == "yes") {
                    $("#form").submit()
                } else {
                    alert("Give iza enta bddak ta3tih, take iza hwwi bddo ya3tik")
                }
            });
            $('#image').on('change', function () {
                var $files = $(this).get(0).files;

                if ($files.length) {
                    // Reject big files
                    if ($files[0].size > $(this).data('max-size') * 1024) {
                        console.log('Please select a smaller file');
                        return false;
                    }
                    console.log('Uploading file to Imgur..');
                    var apiUrl = 'https://api.imgur.com/3/image';
                    var apiKey = 'de1f436286677e8';
                    var settings = {
                        async: false,
                        crossDomain: true,
                        processData: false,
                        contentType: false,
                        type: 'POST',
                        url: apiUrl,
                        headers: {
                            Authorization: 'Client-ID ' + apiKey,
                            Accept: 'application/json',
                        },
                        mimeType: 'multipart/form-data',
                    };

                    var formData = new FormData();
                    formData.append('image', $files[0]);
                    settings.data = formData;
                    $.ajax(settings).done(function (response) {
                        $("#id_image").val(JSON.parse(response).data["link"])
                        alert("Image uploaded successfully")
                    });
                }
            });
        });
    </script>
{% endblock %}